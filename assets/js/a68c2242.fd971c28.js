"use strict";(self.webpackChunkrekalogika_docs=self.webpackChunkrekalogika_docs||[]).push([[8655],{189:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>s,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"file-bundle/advanced/entity-association-internal","title":"File Association Internal Details","description":"Where The Files Are Stored","source":"@site/docs/file-bundle/advanced/21-entity-association-internal.md","sourceDirName":"file-bundle/advanced","slug":"/file-bundle/advanced/entity-association-internal","permalink":"/file-bundle/advanced/entity-association-internal","draft":false,"unlisted":false,"editUrl":"https://github.com/rekalogika/rekalogika-docs/edit/main/docs/file-bundle/advanced/21-entity-association-internal.md","tags":[],"version":"current","sidebarPosition":21,"frontMatter":{"title":"File Association Internal Details"},"sidebar":"docs","previous":{"title":"Command Line Utilities","permalink":"/file-bundle/cli"},"next":{"title":"Creating Filters","permalink":"/file-bundle/advanced/creating-filters"}}');var o=n(4848),r=n(8453);const s={title:"File Association Internal Details"},a=void 0,l={},c=[{value:"Where The Files Are Stored",id:"where-the-files-are-stored",level:2},{value:"Overriding How the Framework Determines Where to Store the Files",id:"overriding-how-the-framework-determines-where-to-store-the-files",level:2},{value:"Determining the File Location",id:"determining-the-file-location",level:2},{value:"About File Names",id:"about-file-names",level:2},{value:"How It Works",id:"how-it-works",level:2},{value:"Architecture",id:"architecture",level:2}];function h(e){const t={code:"code",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.h2,{id:"where-the-files-are-stored",children:"Where The Files Are Stored"}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.code,{children:"FileLocationResolverInterface"})," decides where to store the file. It takes the\nentity instance and the name of the property holding the file and outputs a\n",(0,o.jsx)(t.code,{children:"FilePointer"})," describing where the file in that property will be stored. The\ndefault implementation ",(0,o.jsx)(t.code,{children:"DefaultFileLocationResolver"})," stores files into the\nfilesystem with the identifier 'default' and the key similar to the following:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"entity/ffa87ef3fc5388bc8b666e2cec17d27cc493d0c1/image/e5/80/72/6d/31337\n\u2570----\u256f \u2570--------------------------------------\u256f \u2570---\u256f \u2570---------\u256f \u2570---\u256f\n  A                      B                        C        D        E\n"})}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"A: Prefix, defaults to 'entity'."}),"\n",(0,o.jsx)(t.li,{children:"B: SHA-1 hash of the entity's fully-qualified class name."}),"\n",(0,o.jsx)(t.li,{children:"C: Property name."}),"\n",(0,o.jsx)(t.li,{children:"D: Hashed directories of the entity's ID. The ID is hashed using SHA-1, then\nsplit by 2 characters each. Then, the first four of them are taken to form\nthe directory structure."}),"\n",(0,o.jsx)(t.li,{children:"E: The entity ID."}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:"This default should be sufficient in most cases, for all entities, and all\ntypes of file system. It is chosen with the following objectives in mind:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"It masks internal details (entity class names) because we may need to expose\nthe name to the Internet."}),"\n",(0,o.jsx)(t.li,{children:"It does not store too many files in a single directory because some\nfile system types struggle with a huge number of files in a directory."}),"\n",(0,o.jsx)(t.li,{children:"The ordering is chosen to make it easier for manual administration tasks."}),"\n"]}),"\n",(0,o.jsxs)(t.p,{children:["To obtain the entity's ID, ",(0,o.jsx)(t.code,{children:"DefaultFileLocationResolver"})," calls\n",(0,o.jsx)(t.code,{children:"ObjectIdResolverInterface"}),". By default, it is ",(0,o.jsx)(t.code,{children:"DoctrineObjectIdResolver"})," which\nobtains the ID from Doctrine Entity Manager."]}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.code,{children:"DefaultFileLocationResolver"})," then uses\n",(0,o.jsx)(t.code,{children:"ClassBasedFileLocationResolverInterface"})," to determine the location of the file\nwhich ultimately provides the above logic."]}),"\n",(0,o.jsx)(t.h2,{id:"overriding-how-the-framework-determines-where-to-store-the-files",children:"Overriding How the Framework Determines Where to Store the Files"}),"\n",(0,o.jsxs)(t.p,{children:["To override the algorithm that determines where to store the files, you can\ncreate your own implementation of ",(0,o.jsx)(t.code,{children:"ClassBasedFileLocationResolverInterface"}),". It\ntakes the class name of the object, the ID, and the property name; then returns\na ",(0,o.jsx)(t.code,{children:"FilePointerInterface"}),"."]}),"\n",(0,o.jsxs)(t.p,{children:["Alternatively, you can also implement ",(0,o.jsx)(t.code,{children:"FileLocationResolverInterface"})," that takes\nthe object and the property name instead. But here you need to be careful to\nnormalize the class name, as the object you get might be a proxy of the real\nobject."]}),"\n",(0,o.jsxs)(t.p,{children:["You can also create an ",(0,o.jsx)(t.code,{children:"ObjectIdResolverInterface"})," if you need to override how\nthe framework obtains an object's identifier. This is usually only necessary if\nyour object's ID cannot be serialized to string."]}),"\n",(0,o.jsx)(t.p,{children:"If you are using autoconfiguration, then you don't need to do anything else.\nOtherwise, you have to tag them in the service container. Example:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-yaml",children:"services:\n    App\\MyClassBasedFileLocationResolver:\n        tags:\n            - { name: 'rekalogika.file.association.class_based_file_location_resolver' }\n    App\\MyFileLocationResolver:\n        tags:\n            - { name: 'rekalogika.file.association.file_location_resolver' }\n    App\\MyObjectIdResolver:\n        tags:\n            - { name: 'rekalogika.file.association.object_id_resolver' }\n"})}),"\n",(0,o.jsx)(t.h2,{id:"determining-the-file-location",children:"Determining the File Location"}),"\n",(0,o.jsxs)(t.p,{children:["To determine the location of a file, you can use the ",(0,o.jsx)(t.code,{children:"rekalogika:file:resolve"}),"\ncommand. The command takes the entity class, the identifier, and the property\nname of the file in the class, in that order:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-bash",children:"$ php bin/console rekalogika:file:resolve 'App\\Entity\\Article' 01955f6c-f3ff-7830-b78b-1b06603c1c98 image\n"})}),"\n",(0,o.jsx)(t.h2,{id:"about-file-names",children:"About File Names"}),"\n",(0,o.jsx)(t.p,{children:"Like modern key-value cloud storage services, this framework uses the concept of\n'keys', not 'paths'. The file name is not used as the name of the key but is\nstored in the metadata, along with other properties of the file (file size,\ntype, etc.). The original file name is never considered when determining where to\nstore the file."}),"\n",(0,o.jsx)(t.p,{children:"The metadata itself is stored in a sidecar file. Using the example above, the\nmetadata will be stored in this location:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{children:"entity/ffa87ef3fc5388bc8b666e2cec17d27cc493d0c1/image/e5/80/72/6d/31337.metadata\n"})}),"\n",(0,o.jsx)(t.p,{children:"The caller can obtain the file name using the appropriate methods:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-php",children:"$imageFilename = $entity->getImage()?->getName();\n"})}),"\n",(0,o.jsx)(t.p,{children:"When possible, the framework should copy the file name of the original file to\nthe destination metadata when the file was first associated with the entity."}),"\n",(0,o.jsx)(t.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,o.jsx)(t.p,{children:"The storage key of the file is deterministic. It is determined only by the\nobject's class name, the object's ID, and the name of the property containing the\nfile. As long as those don't change, the key will remain the same."}),"\n",(0,o.jsx)(t.p,{children:"When persisting an entity, the framework will calculate the destination storage\nkey of every applicable property of the entity, and compare it to the current\nfile residing on each property:"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:"If both are the same, the framework leaves it alone."}),"\n",(0,o.jsx)(t.li,{children:"If they are different, the framework will copy the file from the entity to the\nstorage destination."}),"\n",(0,o.jsx)(t.li,{children:"If null, the framework will attempt to remove the file from the storage,\nirrespective of whether the file exists or not."}),"\n"]}),"\n",(0,o.jsx)(t.h2,{id:"architecture",children:"Architecture"}),"\n",(0,o.jsxs)(t.p,{children:["In a nutshell: Doctrine Unit Of Work \u27a1\ufe0f Doctrine Events \u27a1\ufe0f\nrekalogika/reconstitutor \u27a1\ufe0f ",(0,o.jsx)(t.code,{children:"InterfaceReconstitutor"})," & ",(0,o.jsx)(t.code,{children:"AttributeReconstitutor"}),"\n\u27a1\ufe0f ",(0,o.jsx)(t.code,{children:"FileAssociationManager"})," \u27a1\ufe0f ",(0,o.jsx)(t.code,{children:"FileRepository"})," (from rekalogika/file)."]}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.code,{children:"InterfaceReconstitutor"})," & ",(0,o.jsx)(t.code,{children:"AttributeReconstitutor"})," are the entry points of this\npackage. They execute methods of ",(0,o.jsx)(t.code,{children:"FileAssociationManager"})," which works with the\nentities and ",(0,o.jsx)(t.code,{children:"FileRepository"})," to manage the association between the entities and\nfiles."]}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.code,{children:"InterfaceReconstitutor"})," & ",(0,o.jsx)(t.code,{children:"AttributeReconstitutor"})," are registered to the\nservice container so that they are called by our ",(0,o.jsx)(t.code,{children:"rekalogika/reconstitutor"})," when\nthe relevant events are being emitted by Doctrine. The service configuration is\ndone by the package ",(0,o.jsx)(t.code,{children:"rekalogika/file-bundle"}),"."]})]})}function d(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>s,x:()=>a});var i=n(6540);const o={},r=i.createContext(o);function s(e){const t=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),i.createElement(r.Provider,{value:t},e.children)}}}]);